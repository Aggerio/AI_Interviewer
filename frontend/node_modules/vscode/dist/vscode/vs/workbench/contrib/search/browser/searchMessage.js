import * as nls from 'monaco-editor/esm/vs/nls.js';
import * as dom from 'monaco-editor/esm/vs/base/browser/dom.js';
import { parseLinkedText } from 'monaco-editor/esm/vs/base/common/linkedText.js';
import Severity from 'monaco-editor/esm/vs/base/common/severity.js';
import { SeverityIcon } from 'monaco-editor/esm/vs/platform/severityIcon/browser/severityIcon.js';
import { TextSearchCompleteMessageType } from '../../../services/search/common/searchExtTypes.js';
import { Schemas } from 'monaco-editor/esm/vs/base/common/network.js';
import { Link } from 'monaco-editor/esm/vs/platform/opener/browser/link.js';
import { URI } from 'monaco-editor/esm/vs/base/common/uri.js';
const renderSearchMessage = (message, instantiationService, notificationService, openerService, commandService, disposableStore, triggerSearch) => {
    const div = dom.$('div.providerMessage');
    const linkedText = parseLinkedText(message.text);
    dom.append(div, dom.$('.' +
        SeverityIcon.className(message.type === TextSearchCompleteMessageType.Information
            ? Severity.Info
            : Severity.Warning)
            .split(' ')
            .join('.')));
    for (const node of linkedText.nodes) {
        if (typeof node === 'string') {
            dom.append(div, document.createTextNode(node));
        }
        else {
            const link = instantiationService.createInstance(Link, div, node, {
                opener: async (href) => {
                    if (!message.trusted) {
                        return;
                    }
                    const parsed = ( URI.parse(href, true));
                    if (parsed.scheme === Schemas.command && message.trusted) {
                        const result = await commandService.executeCommand(parsed.path);
                        if (result?.triggerSearch) {
                            triggerSearch();
                        }
                    }
                    else if (parsed.scheme === Schemas.https) {
                        openerService.open(parsed);
                    }
                    else {
                        if (parsed.scheme === Schemas.command && !message.trusted) {
                            notificationService.error(( nls.localize(
                                'unable to open trust',
                                "Unable to open command link from untrusted source: {0}",
                                href
                            )));
                        }
                        else {
                            notificationService.error(( nls.localize('unable to open', "Unable to open unknown link: {0}", href)));
                        }
                    }
                }
            });
            disposableStore.add(link);
        }
    }
    return div;
};
export { renderSearchMessage };
